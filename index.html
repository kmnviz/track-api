<!doctype html>
<html>
<head>
    <title>This is the title of the webpage!</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
</head>
<body>
    <div style="margin-bottom: 16px;">
        <audio id="audio" controls></audio>
    </div>
    <button id="fetch-tracks" onclick="fetchTracks()">fetch tracks</button>
    <ul id="list"></ul>
</body>
<script>
// fetch
const fetchTracks = () => {
    const url = 'http://localhost:3030/read/1';
    const listEl = document.getElementById('list');

    axios.get(url).then((res) => {
        Object.keys(res['data']['data']).forEach((key) => {
            const el = document.createElement('li');
            const duration = res['data']['data'][key]['meta']['duration'];
            el.innerHTML = `<button style="margin-bottom: 8px;" onclick="play('${key}', '${duration}')">${key}</button>`;
            listEl.appendChild(el);
        });
        document.getElementById('fetch-tracks').remove();
    });
};
const fetchChunk = (number, id, sourceBuffer) => {
    return new Promise((resolve) => {
        axios.get(`${url}/${id}/${number * 10}`, { responseType: 'arraybuffer' })
            .then((res) => {
                sourceBuffer.appendBuffer(res['data']);
                resolve(number);
            });
    });
};
const fetchNext = (number, id, chunkCounts, sourceBuffer) => {
    fetchChunk(number, id, sourceBuffer).then(() => {
        number++;
        if (number < chunkCounts) {
            fetchNext(number, id, chunkCounts, sourceBuffer);
        }
    });
};

const url = 'http://localhost:3030/chunk/1';
const chunkDuration = 10;
const mimeCodec = 'audio/mpeg';
let duration = 0;

const play = (id, duration) => {
    const audioElement = document.getElementById('audio');
    const mediaSource = new MediaSource;

    audioElement.src = URL.createObjectURL(mediaSource);
    mediaSource.addEventListener('sourceopen', () => {
        mediaSource.duration = duration;
        const sourceBuffer = mediaSource.addSourceBuffer(mimeCodec);
        const chunkCounts = Math.floor(duration / chunkDuration) + 1;
        fetchNext(0, id, chunkCounts, sourceBuffer);
        audioElement.play();
    });
};
</script>
</html>