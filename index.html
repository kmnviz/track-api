<!doctype html>
<html>
<head>
    <title>This is the title of the webpage!</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
</head>
<body>
    <div style="margin-bottom: 16px;">
        <audio id="audio" controls></audio>
    </div>
    <button id="fetch-tracks" onclick="fetchTracks()">fetch tracks</button>
    <ul id="list"></ul>
</body>
<script>
const getRandomInt = (max) => {
    return Math.floor(Math.random() * Math.floor(max));
};

const fetchTracks = () => {
    const url = 'http://localhost:3030/read/1';
    const listEl = document.getElementById('list');

    axios.get(url).then((res) => {
        Object.keys(res['data']['data']).forEach((key) => {
            const el = document.createElement('li');
            const duration = res['data']['data'][key]['meta']['duration'];
            const randomSec = getRandomInt(duration);
            el.innerHTML = `
                <button style="margin-bottom: 4px;" onclick="play('${key}', '${duration}')">${key}</button>
                <br />
                <button style="margin-bottom: 8px;" onclick="play('${key}', '${duration}', '${randomSec}')">${key} (${randomSec}/${duration} sec)</button>
            `;
            listEl.appendChild(el);
        });
        document.getElementById('fetch-tracks').remove();
    });
};
const fetchChunk = (chunkNumber, id, sourceBuffer) => {
    return new Promise((resolve) => {
        axios.get(`${url}/${id}/${chunkNumber * 10}`, { responseType: 'arraybuffer' })
            .then((res) => {
                sourceBuffer.appendBuffer(res['data']);
                resolve(chunkNumber);
            });
    });
};
const fetchNext = (chunkNumber, id, chunkCounts, sourceBuffer) => {
    fetchChunk(chunkNumber, id, sourceBuffer).then(() => {
        chunkNumber++;
        if (chunkNumber < chunkCounts) {
            fetchNext(chunkNumber, id, chunkCounts, sourceBuffer);
        }
    });
};

const audioElement = document.getElementById('audio');
const url = 'http://localhost:3030/chunk/1';
const chunkDuration = 10;
const mimeCodec = 'audio/mpeg';

// TODO: Set current time to start
const play = (id, duration, start = 0) => {
    const mediaSource = new MediaSource;
    audioElement.src = URL.createObjectURL(mediaSource);

    mediaSource.addEventListener('sourceopen', () => {
        mediaSource.duration = duration;
        const sourceBuffer = mediaSource.addSourceBuffer(mimeCodec);
        const chunkCounts = Math.floor(duration / chunkDuration) + 1;
        const chunkNumber = Math.floor(start / chunkDuration) + 1;
        fetchNext(chunkNumber, id, chunkCounts, sourceBuffer);
        audioElement.play();
    });
};
</script>
</html>